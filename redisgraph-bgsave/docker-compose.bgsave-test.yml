services:
  redisgraph-master:
    image: redislabs/redisgraph:2.12.10
    container_name: redisgraph-master
    # Ports removed - services communicate via internal network
    # Uncomment if you need external access:
    # ports:
    #   - "16379:6379"
    volumes:
      - redisgraph-master-data:/data
    networks:
      - bgsave-test-network
    cap_add:
      - SYS_PTRACE  # Enable ptrace for debugging (gdb, strace, etc.)
    command: >
      redis-server
      --dir /data
      --save 15 1
      --loadmodule /usr/lib/redis/modules/redisgraph.so THREAD_COUNT 40
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redisgraph-replica:
    image: redislabs/redisgraph:2.12.10
    container_name: redisgraph-replica
    # Ports removed - services communicate via internal network
    # Uncomment if you need external access:
    # ports:
    #   - "16380:6379"
    volumes:
      - redisgraph-replica-data:/data
    networks:
      - bgsave-test-network
    cap_add:
      - SYS_PTRACE  # Enable ptrace for debugging (gdb, strace, etc.)
    command: >
      redis-server
      --dir /data
      --save 15 1
      --replicaof redisgraph-master 6379
      --loadmodule /usr/lib/redis/modules/redisgraph.so THREAD_COUNT 40
    depends_on:
      redisgraph-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redisgraph-replica2:
    image: redislabs/redisgraph:2.12.10
    container_name: redisgraph-replica2
    # Ports removed - services communicate via internal network
    # Uncomment if you need external access:
    # ports:
    #   - "16381:6379"
    volumes:
      - redisgraph-replica2-data:/data
    networks:
      - bgsave-test-network
    cap_add:
      - SYS_PTRACE  # Enable ptrace for debugging (gdb, strace, etc.)
    command: >
      redis-server
      --dir /data
      --save 15 1
      --replicaof redisgraph-master 6379
      --loadmodule /usr/lib/redis/modules/redisgraph.so THREAD_COUNT 40
    depends_on:
      redisgraph-master:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  redisgraph-testdriver:
    build:
      context: ./tester
      dockerfile: Dockerfile
    container_name: redisgraph-testdriver
    networks:
      - bgsave-test-network
    environment:
      - REDIS_MASTER=redisgraph-master:6379
      - REDIS_REPLICA=redisgraph-replica:6379
      - REDIS_REPLICA2=redisgraph-replica2:6379
      - QUERY_REPLICAS=redisgraph-replica:6379 # ,redisgraph-replica2:6379
      - SIMPLE_SEED_ONLY=false
      - NUM_GRAPHS=25
      - TARGET_NODES_PER_GRAPH=100
      - JITTER_MAX_MS=200
      - UPDATE_INTERVAL=1s
      - DYNAMIC_GRAPH_INTERVAL=500ms
      - QUERY_INTERVAL=500ms
      - GC_GARBAGE_INTERVAL=1s
      - BGSAVE_INTERVAL=15s
      - NUM_DYNAMIC_GRAPH_WORKERS=5
      - NUM_UPDATE_WORKERS=5
      - NUM_QUERY_WORKERS=10
      - NUM_GC_GARBAGE_WORKERS=10
    depends_on:
      redisgraph-master:
        condition: service_healthy
      redisgraph-replica:
        condition: service_healthy
      redisgraph-replica2:
        condition: service_healthy
    stdin_open: true
    tty: true

volumes:
  redisgraph-master-data:
  redisgraph-replica-data:
  redisgraph-replica2-data:

networks:
  bgsave-test-network:
    driver: bridge

